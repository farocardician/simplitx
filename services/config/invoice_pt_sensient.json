{
  "enabled": true,
  "document": { "type": "invoice", "vendor": "PT Sensient", "version": "1" },
  "ingestion": {
    "type": "xls",
    "pipeline": "xls2sql",
    "source": "services/xls2sql",
    "stages": [
      {
        "script": "stages/s01_postgreimport_sensient.py",
        "args": ["{xls}"],
        "outputs": ["job_id"]
      },
      {
        "script": "stages/s02_validate_resolve_sensient.py",
        "args": ["--job-id", "{job_id}"]
      },
      {
        "script": "stages/s03_build_invoices.py",
        "args": ["--job-id", "{job_id}"]
      }
    ]
  },
  "stages": [
    {
      "script": "stages/s01_postgreimport_sensient.py",
      "args": ["{xls}"]
    },
    {
      "script": "stages/s02_validate_resolve_sensient.py",
      "args": ["--job-id", "{job_id}"]
    },
    {
      "script": "stages/s03_build_invoices.py",
      "args": ["--job-id", "{job_id}"]
    }
  ],
  "queue": {
    "version": "v2",
    "page": "/queue-v2",
    "data_source": "tax_invoices",
    "filter": { "tin": "0021164165056000" },
    "seller_name": "PT Sensient Colors Indonesia"
  },
  "seller": {
    "id": "74490aa0-7490-402f-ac9b-42bd823fb6cb",
    "tax_invoice_opt": "Normal"
  },
  "tax": {
    "vat_rate": 12
  },
  "rounding": {
    "qty": { "scale": 3, "mode": "half_up" },
    "unit_price": { "scale": 2, "mode": "half_up" },
    "tax_base": { "scale": 2, "mode": "half_up" },
    "other_tax_base": { "scale": 2, "mode": "half_up" },
    "vat": { "scale": 2, "mode": "half_up" }
  },
  "upload": {
    "accept": [".xls", ".xlsx"],
    "endpoint": "/api/upload-xls",
    "max_size_mb": 50
  },
  "sql2xml": {
    "mapping": {
      "root": {
        "tag": "TaxInvoiceBulk",
        "nsmap": {
          "xsd": "http://www.w3.org/2001/XMLSchema",
          "xsi": "http://www.w3.org/2001/XMLSchema-instance"
        }
      },
      "structure": {
        "TIN": "$.data.invoice.tin",
        "ListOfTaxInvoice": {
          "TaxInvoice": {
            "TaxInvoiceDate": "$.data.invoice.tax_invoice_date",
            "TaxInvoiceOpt": "$.data.invoice.tax_invoice_opt",
            "TrxCode": "$.data.invoice.trx_code",
            "AddInfo": "$.data.invoice.add_info",
            "CustomDoc": "$.data.invoice.custom_doc",
            "CustomDocMonthYear": "$.data.invoice.custom_doc_month_year",
            "RefDesc": "$.data.invoice.ref_desc",
            "FacilityStamp": "$.data.invoice.facility_stamp",
            "SellerIDTKU": "$.data.invoice.seller_idtku",
            "BuyerTin": "$.data.buyer.tin",
            "BuyerDocument": "$.data.buyer.document",
            "BuyerCountry": "$.data.buyer.country",
            "BuyerDocumentNumber": "$.data.buyer.document_number",
            "BuyerName": "$.data.buyer.name",
            "BuyerAdress": "$.data.buyer.address",
            "BuyerEmail": "$.data.buyer.email",
            "BuyerIDTKU": "$.data.buyer.idtku",
            "ListOfGoodService": {
              "_array": "$.data.items[*]",
              "GoodService": {
                "Opt": "$.opt",
                "Code": "$.code",
                "Name": "$.name",
                "Unit": "$.unit",
                "Price": { "path": "$.price", "format": { "type": "decimal", "scale": 2 } },
                "Qty": "$.qty",
                "TotalDiscount": { "path": "$.total_discount", "format": { "type": "decimal", "scale": 2 } },
                "TaxBase": { "path": "$.tax_base", "format": { "type": "decimal", "scale": 2 } },
                "OtherTaxBase": { "path": "$.other_tax_base", "format": { "type": "decimal", "scale": 2 } },
                "VATRate": "$.vat_rate",
                "VAT": { "path": "$.vat", "format": { "type": "decimal", "scale": 2 } },
                "STLGRate": "$.stlg_rate",
                "STLG": { "path": "$.stlg", "format": { "type": "decimal", "scale": 2 } }
              }
            }
          }
        }
      }
    }
  },
  "sql2csv": {
    "enabled": true,
    "mapping": {
      "columns": [
        { "header": "opt", "source": "item", "path": "opt", "type": "string" },
        { "header": "code", "source": "item", "path": "code", "type": "string" },
        { "header": "name", "source": "item", "path": "name", "type": "string" },
        { "header": "unit", "source": "item", "path": "unit", "type": "string" },
        { "header": "price", "source": "item", "path": "price", "type": "decimal", "scale": 2 },
        { "header": "qty", "source": "item", "path": "qty", "type": "decimal", "scale": 3 },
        { "header": "total_discount", "source": "item", "path": "total_discount", "type": "decimal", "scale": 2 },
        { "header": "tax_base", "source": "item", "path": "tax_base", "type": "decimal", "scale": 2 },
        { "header": "other_tax_base", "source": "item", "path": "other_tax_base", "type": "decimal", "scale": 2 },
        { "header": "vat_rate", "source": "item", "path": "vat_rate", "type": "decimal", "scale": 0 },
        { "header": "vat", "source": "item", "path": "vat", "type": "decimal", "scale": 2 },
        { "header": "stlg_rate", "source": "item", "path": "stlg_rate", "type": "decimal", "scale": 0 },
        { "header": "stlg", "source": "item", "path": "stlg", "type": "decimal", "scale": 2 },
        { "header": "grand_total", "source": "item", "path": "grand_total", "type": "expression", "expr": "tax_base + vat + stlg", "scale": 2 },
        { "header": "invoice_number", "source": "invoice", "path": "number", "type": "string" },
        { "header": "tax_invoice_date", "source": "invoice", "path": "tax_invoice_date", "type": "date" },
        { "header": "buyer_name", "source": "buyer", "path": "name", "type": "string" }
      ],
      "format": {
        "delimiter": ",",
        "quoting": "minimal",
        "encoding": "utf-8"
      }
    }
  }
}
