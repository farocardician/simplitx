// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id              String    @id @default(uuid())
  ownerSessionId  String?   @map("owner_session_id")
  userId          String?   @map("user_id")
  
  originalFilename String   @map("original_filename")
  contentType     String    @default("application/pdf") @map("content_type")
  bytes           BigInt
  sha256          String    @db.Char(64)
  mapping         String    @default("pt_simon_invoice_v1")
  
  status          JobStatus @default(uploaded)
  uploadPath      String?   @map("upload_path")
  resultPath      String?   @map("result_path")
  artifactPath    String?   @map("artifact_path")
  errorCode       String?   @map("error_code")
  errorMessage    String?   @map("error_message")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  queuedAt        DateTime? @map("queued_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  failedAt        DateTime? @map("failed_at")
  
  leasedBy        String?   @map("leased_by")
  leaseExpiresAt  DateTime? @map("lease_expires_at")
  attemptCount    Int       @default(0) @map("attempt_count")
  
  expiresAt       DateTime? @map("expires_at")
  downloadCount   Int       @default(0) @map("download_count")
  firstDownloadAt DateTime? @map("first_downloaded_at")
  approved        Boolean   @default(false)
  approvedAt      DateTime? @map("approved_at")
  
  @@unique([ownerSessionId, sha256, mapping, bytes])
  @@index([status, createdAt(sort: Desc)])
  @@index([ownerSessionId, status])
  @@index([ownerSessionId, createdAt(sort: Desc)])
  @@index([leaseExpiresAt])
  @@map("jobs")
}

enum JobStatus {
  uploaded
  queued
  processing
  complete
  failed
  @@map("job_status")
}

model Vendor {
  id              String    @id @default(uuid())
  name            String    @unique
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  productInfo     ProductInformation[]

  @@map("vendors")
}

model Uom {
  code            String    @id // e.g., "UM.0021"
  name            String    // e.g., "Piece"
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  productInfo     ProductInformation[]

  @@map("uom_codes")
}

model ProductInformation {
  id              String    @id @default(uuid())
  vendorId        String    @map("vendor_id")
  sku             String?
  description     String    @db.Text
  uomCode         String?   @map("uom_code")
  optCode         String?   @map("opt_code")
  hsCode          String?   @map("hs_code")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  uom             Uom?      @relation(fields: [uomCode], references: [code])

  @@unique([vendorId, sku])
  @@unique([vendorId, description])
  @@index([vendorId])
  @@map("product_information")
}