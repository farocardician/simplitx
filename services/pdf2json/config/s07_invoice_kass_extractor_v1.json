{
  "profile": {
    "name": "invoice_kass_v1",
    "fail_mode": "soft",
    "required_fields": ["buyer_name", "invoice_number", "invoice_date"],
    "expected_fields": ["subtotal", "tax_base", "tax_amount", "grand_total"],
    "optional_fields": ["seller", "currency", "tax", "income_tax", "income_tax_amount", "zero_tax"]
  },
  "use_stage2_normalized": true,
  "guards": {
    "invoice_number": { "allowed_chars": "A-Za-z0-9-#./ ", "min_len": 5, "max_len": 50 },
    "invoice_date": { "min_len": 8, "max_len": 20 },
    "buyer_name": { "min_len": 3, "max_len": 100 }
  },
  "confidence": {
    "thresholds": {
      "high": { "max_lines": 1, "max_tokens": 15 },
      "medium": { "max_lines": 3, "max_tokens": 60 }
    }
  },
  "totals": { "mode": "segments_only" },
  "fields": {
    "buyer_name": {
      "segment": "buyer_name",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "(?s)[Bb]ill\\s*[Tt]o\\b\\s*[:\\-]*\\s*(?:\\r?\\n|\\s)+([^\\r\\n]+)"
        ]
      }
    },
    "invoice_number": {
      "segment": "invoice_number",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "(?i)(?:TI\\s*No\\.?\\s*[:#-]?\\s*)(TI\\d+)",
          "\\b(TI\\d+)\\b"
        ]
      }
    },
    "invoice_date": {
      "segment": "invoice_date",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "(\\d{1,2}\\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\\s+\\d{4})",
          "(\\d{4}-\\d{2}-\\d{2})",
          "(\\d{1,2}/\\d{1,2}/\\d{4})"
        ]
      }
    },
    "seller": {
      "segment": "seller",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "(PT\\s+[A-Za-z][A-Za-z0-9\\s\\.\\-&,]+)",
          "([A-Z][A-Za-z0-9\\s\\.\\-&,]{5,})"
        ]
      }
    },
    "currency": {
      "segment": "currency",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "([A-Z]{3})\\d",
          "([A-Z]{3})\\s*\\d",
          "\\b([A-Z]{3})\\b"
        ]
      }
    },
    "seller_name": {
      "strategy": "constant",
      "post": { "value": "PT KASS INDONESIA IP SERVICES" }
    },
    "subtotal": {
      "segment": "subtotal",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "([\\d,]+\\.?\\d*)",
          "([\\(\\-]?\\d{1,3}(?:[.,]\\d{3})*(?:[.,]\\d+)?[\\)]?)"
        ]
      }
    },
    "tax_base": {
      "segment": "tax_base",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "([\\d,]+\\.?\\d*)",
          "([\\(\\-]?\\d{1,3}(?:[.,]\\d{3})*(?:[.,]\\d+)?[\\)]?)"
        ]
      }
    },
    "tax": {
      "segment": "tax",
      "strategy": "constant",
      "post": { "value": "12%" }
    },     
    "tax_amount": {
      "segment": "tax",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "\\d{1,2}\\s*%[^\\d]*([\\d,]+\\.?\\d*)",
          "([\\(\\-]?\\d{1,3}(?:[.,]\\d{3})*(?:[.,]\\d+)?[\\)]?)"
        ]
      }
    },
    "income_tax": {
      "segment": "income_tax",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "(\\d{1,2}\\s*%)",
          "(?:PPH|Income\\s*Tax)\\s*(\\d{1,2}\\s*%)"
        ]
      }
    },
    "income_tax_amount": {
      "segment": "income_tax",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "\\d{1,2}\\s*%[^\\d]*([\\d,]+\\.?\\d*)",
          "([\\(\\-]?\\d{1,3}(?:[.,]\\d{3})*(?:[.,]\\d+)?[\\)]?)"
        ]
      }
    },
    "grand_total": {
      "segment": "grand_total",
      "strategy": "regex_capture",
      "post": {
        "regex_pattern": [
          "([\\d,]+\\.?\\d*)",
          "([\\(\\-]?\\d{1,3}(?:[.,]\\d{3})*(?:[.,]\\d+)?[\\)]?)"
        ]
      }
    }
  }
}
