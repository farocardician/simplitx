// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Job {
  id              String    @id @default(uuid())
  ownerSessionId  String?   @map("owner_session_id")
  userId          String?   @map("user_id")

  originalFilename String   @map("original_filename")
  contentType     String    @default("application/pdf") @map("content_type")
  bytes           BigInt
  sha256          String    @db.Char(64)
  mapping         String    @default("pt_simon_invoice_v1")

  status          JobStatus @default(uploaded)
  uploadPath      String?   @map("upload_path")
  resultPath      String?   @map("result_path")
  artifactPath    String?   @map("artifact_path")
  errorCode       String?   @map("error_code")
  errorMessage    String?   @map("error_message")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  queuedAt        DateTime? @map("queued_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  failedAt        DateTime? @map("failed_at")

  leasedBy        String?   @map("leased_by")
  leaseExpiresAt  DateTime? @map("lease_expires_at")
  attemptCount    Int       @default(0) @map("attempt_count")

  expiresAt       DateTime? @map("expires_at")
  downloadCount   Int       @default(0) @map("download_count")
  firstDownloadAt DateTime? @map("first_downloaded_at")

  approved        Boolean   @default(false)
  approvedAt      DateTime? @map("approved_at")

  buyerPartyId              String?   @map("buyer_party_id") @db.Uuid
  buyerResolutionStatus     String?   @map("buyer_resolution_status")
  buyerResolutionConfidence Float?    @map("buyer_resolution_confidence")
  buyerResolutionDecidedAt  DateTime? @map("buyer_resolution_decided_at")

  @@unique([ownerSessionId, sha256, mapping, bytes])
  @@index([status, createdAt(sort: Desc)])
  @@index([ownerSessionId, status])
  @@index([ownerSessionId, createdAt(sort: Desc)])
  @@index([leaseExpiresAt])
  @@map("jobs")
}

enum JobStatus {
  uploaded
  queued
  processing
  complete
  failed
  @@map("job_status")
}

model ParserResult {
  docId     String   @id @map("doc_id")
  final     Json
  manifest  Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("parser_results")
}

model UnitOfMeasure {
  code    String     @id
  name    String
  aliases UomAlias[]

  @@map("unit_of_measures")
}

model UomAlias {
  alias     String        @id
  uomCode   String        @map("uom_code")
  uom       UnitOfMeasure @relation(fields: [uomCode], references: [code], onDelete: Cascade)
  isPrimary Boolean       @default(false) @map("is_primary")
  createdAt DateTime      @default(now()) @map("created_at")

  @@index([uomCode])
  @@map("uom_aliases")
}

model Party {
  id              String    @id @default(uuid()) @db.Uuid
  displayName     String    @map("display_name")
  nameNormalized  String    @map("name_normalized")
  tinDisplay      String    @map("tin_display")
  tinNormalized   String    @map("tin_normalized")
  countryCode     String?   @map("country_code") @db.Char(3)
  addressFull     String?   @map("address_full")
  email           String?
  buyerDocument   String?   @default("TIN") @map("buyer_document") @db.VarChar(50)
  buyerDocumentNumber String? @map("buyer_document_number") @db.VarChar(100)
  buyerIdtku      String?   @map("buyer_idtku") @db.VarChar(100)
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  createdBy       String?   @map("created_by")
  updatedBy       String?   @map("updated_by")

  @@index([deletedAt], map: "idx_parties_deleted_at")
  @@map("parties")
}

model TransactionCode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique @db.VarChar(10)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([code])
  @@map("transaction_codes")
}

model HsCode {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code          String   @db.VarChar(6)
  level         HsLevel
  jurisdiction  String   @default("ID") @db.VarChar(10)
  versionYear   Int      @default(2022) @map("version_year")
  parentCode    String?  @map("parent_code") @db.VarChar(6)
  descriptionEn String   @map("description_en") @db.Text
  descriptionId String   @map("description_id") @db.Text
  notes         String?  @db.Text
  validFrom     DateTime? @map("valid_from")
  validTo       DateTime? @map("valid_to")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  @@unique([jurisdiction, versionYear, code], name: "hs_codes_unique_code")
  @@index([jurisdiction, versionYear, code], name: "idx_hs_codes_jurisdiction_version_code")
  @@index([code(ops: raw("text_pattern_ops"))], name: "idx_hs_codes_code_pattern")
  @@index([parentCode], name: "idx_hs_codes_parent")
  @@index([level], name: "idx_hs_codes_level")
  @@map("hs_codes")
}

enum HsLevel {
  HS2
  HS4
  HS6

  @@map("hs_level")
}
